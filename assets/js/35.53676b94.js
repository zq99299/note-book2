(window.webpackJsonp=window.webpackJsonp||[]).push([[35],{529:function(t,s,n){t.exports=n.p+"assets/img/image-20210306160058378.b51a1c09.png"},530:function(t,s,n){t.exports=n.p+"assets/img/006059602ee75b176a80429f49ffc9aa.00605960.png"},531:function(t,s,n){t.exports=n.p+"assets/img/image-20210306162038091.f8ee0fb6.png"},532:function(t,s,n){t.exports=n.p+"assets/img/image-20210306163959411.eb490ef2.png"},748:function(t,s,n){"use strict";n.r(s);var a=n(13),e=Object(a.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"_04-四通八达-http-的重定向和跳转"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_04-四通八达-http-的重定向和跳转"}},[t._v("#")]),t._v(" 04 | 四通八达：HTTP 的重定向和跳转")]),t._v(" "),a("p",[t._v("为了实现在互联网上构建超链接文档系统的设想，蒂姆·伯纳斯 - 李发明了万维网，使用 HTTP 协议传输 "),a("strong",[t._v("超文本")]),t._v(" ，让全世界的人都能够自由地共享信息。")]),t._v(" "),a("p",[a("strong",[t._v("超文本")]),t._v(" 里含有 "),a("strong",[t._v("超链接")]),t._v(" ，可以从一个超文本跳跃到另一个超文本，对线性结构的传统文档是一个根本性的变革。")]),t._v(" "),a("p",[a("strong",[t._v("能够使用超链接在网络上任意地跳转")]),t._v(" 也是万维网的一个关键特性。它把分散在世界各地的文档连接在一起，形成了复杂的网状结构，用户可以在查看时随意点击链接、转换页面。再加上浏览器又提供了前进、后退、书签等辅助功能，让用户在文档间跳转时更加方便，有了更多的主动性和交互性。")]),t._v(" "),a("p",[t._v("那么，点击页面「链接」时的跳转是怎样的呢？具体一点，比如在 Nginx 的主页上点了一下 download 链接，会发生什么呢？")]),t._v(" "),a("p",[t._v("结合之前的课程，稍微思考一下你就能得到答案：浏览器首先要解析链接文字里的 URI。")]),t._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("http://nginx.org/en/download.html\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])]),a("p",[t._v("再用这个 URI 发起一个新的 HTTP 请求，获取响应报文后就会切换显示内容，渲染出新 URI 指向的页面。")]),t._v(" "),a("p",[t._v("这样的跳转动作是由浏览器的使用者主动发起的，可以称为 "),a("strong",[t._v("主动跳转")]),t._v(" ，但还有一类跳转是由服务器来发起的，浏览器使用者无法控制，相对地就可以称为 "),a("strong",[t._v("被动跳转")]),t._v(" ，这在 HTTP 协议里有个专门的名词，叫做 "),a("strong",[t._v("重定向")]),t._v("（Redirection）。")]),t._v(" "),a("h2",{attrs:{id:"重定向的过程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#重定向的过程"}},[t._v("#")]),t._v(" 重定向的过程")]),t._v(" "),a("p",[t._v("其实之前我们就已经见过重定向了，在 "),a("RouterLink",{attrs:{to:"/http-protocol/03/05.html#_3××"}},[t._v("响应状态码该怎么使用中的 3xx")]),t._v(" 里就说过，301 是 "),a("strong",[t._v("永久重定向")]),t._v(" ，302 是 "),a("strong",[t._v("临时重定向")]),t._v(" ，浏览器收到这两个状态码就会跳转到新的 URI。")],1),t._v(" "),a("p",[t._v("那么，它们是怎么做到的呢？难道仅仅用这两个代码就能够实现跳转页面吗？")]),t._v(" "),a("p",[t._v("先在实验环境里看一下重定向的过程吧，用 Chrome 访问 URI "),a("code",[t._v("http://www.chrono.com/18-1")]),t._v(" ，它会使用 302 立即跳转到 "),a("code",[t._v("/index.html")]),t._v(" 。")]),t._v(" "),a("p",[a("img",{attrs:{src:n(529),alt:"image-20210306160058378"}})]),t._v(" "),a("p",[t._v("该请求一共发起了两个 HTTP 请求：")]),t._v(" "),a("ol",[a("li",[t._v("第一个返回了 302 状态码")]),t._v(" "),a("li",[t._v("第二个请求就被从定向到了 "),a("code",[t._v("/index.html")])])]),t._v(" "),a("p",[t._v("如果不适用开发者工具查看的话，你很难感知到这个跳转过程，也就是说，重定向是 "),a("strong",[t._v("用户无感知")]),t._v(" 的。")]),t._v(" "),a("p",[t._v("另外，第一个请求中的响应头出现了一个新的 "),a("code",[t._v("Location: /index.html")]),t._v(" 字段，它就是 301/302 重定向跳转的秘密所在。")]),t._v(" "),a("p",[a("strong",[t._v("Location")]),t._v(" 字段属于响应字段，必须出现在响应报文里。但只有配合 301/302 状态码才有意义，它 "),a("strong",[t._v("标记了服务器要求重定向的 URI")]),t._v(" ，这里就是要求浏览器跳转到 "),a("code",[t._v("index.html")]),t._v(" 。")]),t._v(" "),a("p",[t._v("浏览器收到 301/302 报文，会检查响应头里有没有 "),a("code",[t._v("Location")]),t._v(" 。如果有，就从字段值里提取出 URI，发出新的 HTTP 请求，相当于自动替我们点击了这个链接。")]),t._v(" "),a("p",[t._v("在 "),a("code",[t._v("Location")]),t._v(" 里的 URI 既可以使用 "),a("strong",[t._v("绝对 URI")]),t._v("，也可以使用 "),a("strong",[t._v("相对 URI")]),t._v(" ：")]),t._v(" "),a("ul",[a("li",[t._v("所谓绝对 URI，就是完整形式的 URI，包括 scheme、host:port、path 等。")]),t._v(" "),a("li",[t._v("所谓相对 URI，就是省略了 scheme 和 host:port，只有 path 和 query 部分，是不完整的，但可以从请求上下文里计算得到。")])]),t._v(" "),a("p",[t._v("例如，刚才的实验例子里的 "),a("code",[t._v("Location: /index.html")]),t._v(" 用的就是相对 URI。它没有说明访问 URI 的协议和主机，但因为是由 "),a("code",[t._v("http://www.chrono.com/18-1")]),t._v(" 重定向返回的响应报文，所以浏览器就可以拼出完整的 URI：")]),t._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("http://www.chrono.com/index.html\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])]),a("p",[t._v("实验环境的 URI "),a("code",[t._v("/18-1")]),t._v(" 还支持使用 query 参数 "),a("code",[t._v("dst=xxx")]),t._v(" ，指明重定向的 URI，你可以用这种形式再多试几次重定向，看看浏览器是如何工作的。")]),t._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("http://www.chrono.com/18-1?dst=https://www.baidu.com\nhttp://www.chrono.com/18-1?dst=/15-1?name=a.json\nhttp://www.chrono.com/18-1?dst=/17-1\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br")])]),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[t._v("dst 参数说明")]),t._v(" "),a("p",[t._v("该参数并不是 HTTP 协议原生功能")])]),t._v(" "),a("p",[t._v("看看 dst 是如何实现 query 中自定义跳转的")]),t._v(" "),a("div",{staticClass:"language-lua line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-lua"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- Copyright (C) 2019 by chrono")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- dst 从 query 中获取，如果没有定义，则赋值为  /index.html")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("local")]),t._v(" dst "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" ngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("var"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("arg_dst "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("or")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/index.html'")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("local")]),t._v(" code "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("tonumber")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("var"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("arg_code "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("or")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("302")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" code "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("~=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("301")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("and")]),t._v(" code "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("~=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("302")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("then")]),t._v("\n    code "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("302")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("end")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- url 编码 dst")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("local")]),t._v(" new_uri "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" ngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("unescape_uri")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dst"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v('--ngx.log(ngx.ERR, "new_uri = ", new_uri)')]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- HTTP header Injection")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" string"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("find")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("new_uri"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'\\r'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("then")]),t._v("\n    ngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("exit")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("400")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("end")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("--if string.byte(new_uri) ~= string.byte('/') then")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("--    new_uri = '/' .. new_uri")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("--end")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- 设置 Referer 头 Referer: /18-1?dst=https://www.baidu.com")]),t._v("\nngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("header"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Referer'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" ngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("var"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("request_uri\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" ngx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("redirect")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("new_uri"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" code"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br"),a("span",{staticClass:"line-number"},[t._v("20")]),a("br"),a("span",{staticClass:"line-number"},[t._v("21")]),a("br"),a("span",{staticClass:"line-number"},[t._v("22")]),a("br"),a("span",{staticClass:"line-number"},[t._v("23")]),a("br"),a("span",{staticClass:"line-number"},[t._v("24")]),a("br"),a("span",{staticClass:"line-number"},[t._v("25")]),a("br"),a("span",{staticClass:"line-number"},[t._v("26")]),a("br"),a("span",{staticClass:"line-number"},[t._v("27")]),a("br"),a("span",{staticClass:"line-number"},[t._v("28")]),a("br"),a("span",{staticClass:"line-number"},[t._v("29")]),a("br"),a("span",{staticClass:"line-number"},[t._v("30")]),a("br")])]),a("p",[t._v("大概的实现流程为：")]),t._v(" "),a("ol",[a("li",[t._v("从 dst 从获取值")]),t._v(" "),a("li",[t._v("给 dst 进行 url 编码，防止是特殊字符")]),t._v(" "),a("li",[t._v("设置 302 状态 和 "),a("strong",[t._v("Location")]),t._v("  头")])]),t._v(" "),a("p",[t._v("注意，在重定向时如果只是在站内跳转，你可以放心地使用相对 URI。但如果要跳转到站外，就必须用绝对 URI。")]),t._v(" "),a("p",[t._v("例如，如果想跳转到 Nginx 官网，就必须在 "),a("code",[t._v("nginx.org")]),t._v(" 前把 "),a("code",[t._v("http://")]),t._v(" 都写出来，否则浏览器会按照相对 URI 去理解，得到的就会是一个不存在的 URI "),a("code",[t._v("http://www.chrono.com/nginx.org")])]),t._v(" "),a("p",[a("img",{attrs:{src:n(530),alt:"img"}})]),t._v(" "),a("p",[t._v("那么，如果 301/302 跳转时没有 Location 字段会怎么样呢？")]),t._v(" "),a("p",[t._v("这个你也可以自己试一下，使用第 12 讲里的 URI "),a("code",[t._v("/12-1")]),t._v(" ，查询参数用 "),a("code",[t._v("code=302")]),t._v(" ：")]),t._v(" "),a("div",{staticClass:"language-http line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-http"}},[a("code",[a("span",{pre:!0,attrs:{class:"token header-name keyword"}},[t._v("http:")]),t._v("//www.chrono.com/12-1?code=302\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])]),a("p",[a("img",{attrs:{src:n(531),alt:"image-20210306162038091"}})]),t._v(" "),a("p",[t._v("响应之后，不会跳转")]),t._v(" "),a("h2",{attrs:{id:"重定向状态码"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#重定向状态码"}},[t._v("#")]),t._v(" 重定向状态码")]),t._v(" "),a("p",[t._v("刚才我把重定向的过程基本讲完了，现在来说一下重定向用到的状态码。")]),t._v(" "),a("p",[t._v("最常见的重定向状态码就是 301 和 302，另外还有几个不太常见的，例如 303、307、308 等。它们最终的效果都差不多，让浏览器跳转到新的 URI，但语义上有一些细微的差别，使用的时候要特别注意。")]),t._v(" "),a("ul",[a("li",[a("p",[a("strong",[t._v("301")]),t._v(" 俗称 "),a("strong",[t._v("永久重定向")]),t._v("（Moved Permanently）")]),t._v(" "),a("p",[t._v("意思是原 URI 已经「永久」性地不存在了，今后的所有请求都必须改用新的 URI。")]),t._v(" "),a("p",[t._v("浏览器看到 301，就知道原来的 URI「过时」了，就会做适当的优化。比如历史记录、更新书签，下次可能就会直接用新的 URI 访问，省去了再次跳转的成本。搜索引擎的爬虫看到 301，也会更新索引库，不再使用老的 URI。")])]),t._v(" "),a("li",[a("p",[a("strong",[t._v("302")]),t._v(" 俗称 "),a("strong",[t._v("临时重定向")]),t._v("（Moved Temporarily），意思是原 URI 处于 "),a("strong",[t._v("临时维护")]),t._v(" 状态，新的 URI 是起顶包作用的临时工。")]),t._v(" "),a("p",[t._v("浏览器或者爬虫看到 302，会认为原来的 URI 仍然有效，但暂时不可用，所以只会执行简单的跳转页面，不记录新的 URI，也不会有其他的多余动作，下次访问还是用原 URI。")])])]),t._v(" "),a("p",[t._v("301/302 是最常用的重定向状态码，在 3×× 里剩下的几个还有：")]),t._v(" "),a("ul",[a("li",[t._v("303 See Other：类似 302，但要求重定向后的请求改为 GET 方法，访问一个结果页面，避免 POST/PUT 重复操作；")]),t._v(" "),a("li",[t._v("307 Temporary Redirect：类似 302，但重定向后请求里的方法和实体不允许变动，含义比 302 更明确；")]),t._v(" "),a("li",[t._v("308 Permanent Redirect：类似 307，不允许重定向后的请求变动，但它是 301 永久重定向的含义。")])]),t._v(" "),a("p",[t._v("不过这三个状态码的接受程度较低，有的浏览器和服务器可能不支持，开发时应当慎重，测试确认浏览器的实际效果后才能使用。")]),t._v(" "),a("h2",{attrs:{id:"重定向的应用场景"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#重定向的应用场景"}},[t._v("#")]),t._v(" 重定向的应用场景")]),t._v(" "),a("p",[t._v("理解了重定向的工作原理和状态码的含义，我们就可以 "),a("strong",[t._v("在服务器端拥有主动权")]),t._v(" ，控制浏览器的行为，不过要怎么利用重定向才好呢？")]),t._v(" "),a("p",[t._v("使用重定向跳转，核心是要理解 "),a("strong",[t._v("重定向")]),t._v(" 和 "),a("strong",[t._v("永久 / 临时")]),t._v(" 这两个关键词。")]),t._v(" "),a("p",[t._v("先来看什么时候需要重定向。")]),t._v(" "),a("p",[t._v("一个最常见的原因就是 "),a("strong",[t._v("资源不可用")]),t._v("，需要用另一个新的 URI 来代替。")]),t._v(" "),a("p",[t._v("至于不可用的原因那就很多了。例如域名变更、服务器变更、网站改版、系统维护，这些都会导致原 URI 指向的资源无法访问，为了避免出现 404，就需要用重定向跳转到新的 URI，继续为网民提供服务。")]),t._v(" "),a("p",[t._v("另一个原因就是 "),a("strong",[t._v("避免重复")]),t._v("，让多个网址都跳转到一个 URI，增加访问入口的同时还不会增加额外的工作量。")]),t._v(" "),a("p",[t._v("例如，有的网站都会申请多个名称类似的域名，然后把它们再重定向到主站上。比如，你可以访问一下 "),a("code",[t._v("qq.com")]),t._v("、"),a("code",[t._v("github.com")]),t._v("、"),a("code",[t._v("bing.com")]),t._v("（记得事先清理缓存），看看它是如何重定向的。")]),t._v(" "),a("p",[t._v("决定要实行重定向后接下来要考虑的就是 "),a("strong",[t._v("永久")]),t._v(" 和 "),a("strong",[t._v("临时")]),t._v(" 的问题了，也就是选择 301 还是 302。")]),t._v(" "),a("p",[t._v("301 的含义是 "),a("strong",[t._v("永久")]),t._v(" 的。")]),t._v(" "),a("p",[t._v("如果域名、服务器、网站架构发生了大幅度的改变，比如启用了新域名、服务器切换到了新机房、网站目录层次重构，这些都算是 "),a("strong",[t._v("永久性")]),t._v(" 的改变。原来的 URI 已经不能用了，必须用 301 永久重定向，通知浏览器和搜索引擎更新到新地址，这也是搜索引擎优化（SEO）要考虑的因素之一。")]),t._v(" "),a("p",[t._v("302 的含义是 "),a("strong",[t._v("临时")]),t._v(" 的。")]),t._v(" "),a("p",[t._v("原来的 URI 在将来的某个时间点还会恢复正常，常见的应用场景就是系统维护，把网站重定向到一个通知页面，告诉用户过一会儿再来访问。另一种用法就是“服务降级”，比如在双十一促销的时候，把订单查询、领积分等不重要的功能入口暂时关闭，保证核心服务能够正常运行。")]),t._v(" "),a("h2",{attrs:{id:"重定向的相关问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#重定向的相关问题"}},[t._v("#")]),t._v(" 重定向的相关问题")]),t._v(" "),a("p",[t._v("重定向的用途很多，掌握了重定向，就能够在架设网站时获得更多的灵活性，不过在使用时还需要注意两个问题。")]),t._v(" "),a("p",[t._v("第一个问题是 "),a("strong",[t._v("性能损耗")]),t._v(" 。很明显，重定向的机制决定了一个跳转会有两次请求 - 应答，比正常的访问多了一次。")]),t._v(" "),a("p",[t._v("虽然 301/302 报文很小，但大量的跳转对服务器的影响也是不可忽视的。站内重定向还好说，可以长连接复用，站外重定向就要开两个连接，如果网络连接质量差，那成本可就高多了，会严重影响用户的体验。")]),t._v(" "),a("p",[t._v("所以重定向应当适度使用，决不能滥用。")]),t._v(" "),a("p",[t._v("第二个问题是 "),a("strong",[t._v("循环跳转")]),t._v(" 。如果重定向的策略设置欠考虑，可能会出现 "),a("code",[t._v("A=>B=>C=>A")]),t._v(" 的无限循环，不停地在这个链路里转圈圈，后果可想而知。")]),t._v(" "),a("p",[t._v("所以 HTTP 协议特别规定，浏览器必须具有检测 "),a("strong",[t._v("循环跳转")]),t._v(" 的能力，在发现这种情况时应当停止发送请求并给出错误提示。")]),t._v(" "),a("p",[t._v("实验环境的 URI "),a("code",[t._v("/18-2")]),t._v(" 就模拟了这样的一个循环跳转，它跳转到 "),a("code",[t._v("/18-1")]),t._v(" ，并用参数 "),a("code",[t._v("dst=/18-2")]),t._v(" 再跳回自己，实现了两个 URI 的无限循环。")]),t._v(" "),a("p",[t._v("使用 Chrome 访问这个地址，会得到 「该网页无法正常运作」的结果：")]),t._v(" "),a("div",{staticClass:"language-http line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-http"}},[a("code",[a("span",{pre:!0,attrs:{class:"token header-name keyword"}},[t._v("http:")]),t._v("//www.chrono.com/18-2\n"),a("span",{pre:!0,attrs:{class:"token header-name keyword"}},[t._v("http:")]),t._v("//www.chrono.com/18-1?dst=18-2\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br")])]),a("p",[a("img",{attrs:{src:n(532),alt:"image-20210306163959411"}})]),t._v(" "),a("p",[t._v("可以看到两个地址来回跳转，跳转很多次后，浏览器报错了")]),t._v(" "),a("h2",{attrs:{id:"小结"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#小结"}},[t._v("#")]),t._v(" 小结")]),t._v(" "),a("p",[t._v("今天我们学习了 HTTP 里的重定向和跳转，简单小结一下这次的内容：")]),t._v(" "),a("ol",[a("li",[t._v("重定向是服务器发起的跳转，要求客户端改用新的 URI 重新发送请求，通常会自动进行，用户是无感知的；")]),t._v(" "),a("li",[t._v("301/302 是最常用的重定向状态码，分别是 "),a("strong",[t._v("永久重定向")]),t._v(" 和 "),a("strong",[t._v("临时重定向")]),t._v(" ；")]),t._v(" "),a("li",[t._v("响应头字段 Location 指示了要跳转的 URI，可以用绝对或相对的形式；")]),t._v(" "),a("li",[t._v("重定向可以把一个 URI 指向另一个 URI，也可以把多个 URI 指向同一个 URI，用途很多；")]),t._v(" "),a("li",[t._v("使用重定向时需要当心性能损耗，还要避免出现循环跳转。")])]),t._v(" "),a("h2",{attrs:{id:"课下作业"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#课下作业"}},[t._v("#")]),t._v(" 课下作业")]),t._v(" "),a("ol",[a("li",[a("p",[t._v("301 和 302 非常相似，试着结合 "),a("RouterLink",{attrs:{to:"/http-protocol/03/05.html"}},[t._v("响应状态码该怎么使用中的 3xx")]),t._v(" ，用自己的理解再描述一下两者的异同点。")],1),t._v(" "),a("p",[t._v("相同点：")]),t._v(" "),a("ul",[a("li",[t._v("都需要配合 Location 字段跳转")]),t._v(" "),a("li",[t._v("都是跳转到另外一个地址")])]),t._v(" "),a("p",[t._v("不同点：")]),t._v(" "),a("ul",[a("li",[t._v("语义不同， 301 永久性，302 临时的")])])]),t._v(" "),a("li",[a("p",[t._v("你能结合自己的实际情况，再列出几个应当使用重定向的场景吗？")])])]),t._v(" "),a("h2",{attrs:{id:"拓展阅读"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#拓展阅读"}},[t._v("#")]),t._v(" 拓展阅读")]),t._v(" "),a("ul",[a("li",[t._v("网页的 "),a("strong",[t._v("入链接")]),t._v(" 和 "),a("strong",[t._v("出链接")]),t._v(" 也是标记网页重要性的关键指标，最著名的就是 Google 发明的 PageRank")]),t._v(" "),a("li",[a("code",[t._v("300 Multiple Choices")]),t._v("  也是一个特殊的重定向状态码，它会返回一个有多个链接选项的页面，由用户自行选择要跳转的链接，用得较少")]),t._v(" "),a("li",[t._v("重定向报文里还可以用 "),a("code",[t._v("Refresh")]),t._v(" 字段，实现延时重定向，例如 "),a("code",[t._v("Refresh: 5; url=xxx")]),t._v(" 告诉浏览器 5 秒后再跳转")]),t._v(" "),a("li",[t._v("与跳转有关的还有一个 "),a("code",[t._v("Referer")]),t._v(" 和 "),a("code",[t._v("Referrer-Policy")]),t._v(" （注意前者是拼写错误的单词，但是已经将错就错），表示浏览器跳转的来源（引用地址），可用于统计分析和防盗链")]),t._v(" "),a("li",[t._v("301/302 重定向是由浏览器执行的，对于服务器来说可以称为 "),a("strong",[t._v("外部重定向")]),t._v("，相应的也就有服务器的 "),a("strong",[t._v("内部重定向")]),t._v("，直接在服务器内部跳转 URI，因为不会发出 HTTP 请求，所以没有额外的性能损失")]),t._v(" "),a("li")])])}),[],!1,null,null,null);s.default=e.exports}}]);