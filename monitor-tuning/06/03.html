<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>垃圾收集器 | NOTE-BOOK2</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/note-book2/favicon.ico">
    <link rel="manifest" href="/note-book2/manifest.json">
    <meta name="description" content="用来记录学习的笔记，在该笔记仓库中的，则是暂未分类的笔记">
    
    <link rel="preload" href="/note-book2/assets/css/0.styles.36b9479e.css" as="style"><link rel="preload" href="/note-book2/assets/js/app.a3ae7deb.js" as="script"><link rel="preload" href="/note-book2/assets/js/2.ad0c12e6.js" as="script"><link rel="preload" href="/note-book2/assets/js/30.4b2ae139.js" as="script"><link rel="preload" href="/note-book2/assets/js/20.86219d72.js" as="script"><link rel="prefetch" href="/note-book2/assets/js/10.fe343229.js"><link rel="prefetch" href="/note-book2/assets/js/11.a1422ae6.js"><link rel="prefetch" href="/note-book2/assets/js/12.a885ab6a.js"><link rel="prefetch" href="/note-book2/assets/js/13.ad990bdf.js"><link rel="prefetch" href="/note-book2/assets/js/14.92ac1bbc.js"><link rel="prefetch" href="/note-book2/assets/js/15.5d237325.js"><link rel="prefetch" href="/note-book2/assets/js/16.0186d36d.js"><link rel="prefetch" href="/note-book2/assets/js/17.09d5e12a.js"><link rel="prefetch" href="/note-book2/assets/js/18.a2b2c32e.js"><link rel="prefetch" href="/note-book2/assets/js/19.80c9ae61.js"><link rel="prefetch" href="/note-book2/assets/js/21.cf67a7e9.js"><link rel="prefetch" href="/note-book2/assets/js/22.5bfb0bd0.js"><link rel="prefetch" href="/note-book2/assets/js/23.5acde4e7.js"><link rel="prefetch" href="/note-book2/assets/js/24.e122a397.js"><link rel="prefetch" href="/note-book2/assets/js/25.6bbbf232.js"><link rel="prefetch" href="/note-book2/assets/js/26.a11b85fd.js"><link rel="prefetch" href="/note-book2/assets/js/27.a90572f0.js"><link rel="prefetch" href="/note-book2/assets/js/28.e33e1479.js"><link rel="prefetch" href="/note-book2/assets/js/29.1d9ff8ca.js"><link rel="prefetch" href="/note-book2/assets/js/3.5a8b6fd5.js"><link rel="prefetch" href="/note-book2/assets/js/31.b8391240.js"><link rel="prefetch" href="/note-book2/assets/js/32.0f1f7e34.js"><link rel="prefetch" href="/note-book2/assets/js/33.55e15ba4.js"><link rel="prefetch" href="/note-book2/assets/js/34.922817ff.js"><link rel="prefetch" href="/note-book2/assets/js/35.ce73a6fa.js"><link rel="prefetch" href="/note-book2/assets/js/36.e834c7db.js"><link rel="prefetch" href="/note-book2/assets/js/37.841675cf.js"><link rel="prefetch" href="/note-book2/assets/js/38.14836dbd.js"><link rel="prefetch" href="/note-book2/assets/js/39.cddb5dd9.js"><link rel="prefetch" href="/note-book2/assets/js/4.2d8648bd.js"><link rel="prefetch" href="/note-book2/assets/js/40.b97236e2.js"><link rel="prefetch" href="/note-book2/assets/js/41.bb9f3ea6.js"><link rel="prefetch" href="/note-book2/assets/js/42.f0290636.js"><link rel="prefetch" href="/note-book2/assets/js/43.b56abd86.js"><link rel="prefetch" href="/note-book2/assets/js/44.a1e67aec.js"><link rel="prefetch" href="/note-book2/assets/js/45.7899cb15.js"><link rel="prefetch" href="/note-book2/assets/js/46.e65f9979.js"><link rel="prefetch" href="/note-book2/assets/js/47.bed0ae3c.js"><link rel="prefetch" href="/note-book2/assets/js/48.c29e8645.js"><link rel="prefetch" href="/note-book2/assets/js/49.64c19b9c.js"><link rel="prefetch" href="/note-book2/assets/js/5.8665c59c.js"><link rel="prefetch" href="/note-book2/assets/js/50.3eff736b.js"><link rel="prefetch" href="/note-book2/assets/js/51.2a298888.js"><link rel="prefetch" href="/note-book2/assets/js/52.341a91d9.js"><link rel="prefetch" href="/note-book2/assets/js/53.6a00dc3c.js"><link rel="prefetch" href="/note-book2/assets/js/54.6c56eef7.js"><link rel="prefetch" href="/note-book2/assets/js/55.44578cdf.js"><link rel="prefetch" href="/note-book2/assets/js/56.f5bcb463.js"><link rel="prefetch" href="/note-book2/assets/js/57.84719457.js"><link rel="prefetch" href="/note-book2/assets/js/58.2682994e.js"><link rel="prefetch" href="/note-book2/assets/js/59.08b28799.js"><link rel="prefetch" href="/note-book2/assets/js/6.aad4b7a1.js"><link rel="prefetch" href="/note-book2/assets/js/60.93ebb93e.js"><link rel="prefetch" href="/note-book2/assets/js/61.37563e85.js"><link rel="prefetch" href="/note-book2/assets/js/62.0f2c2509.js"><link rel="prefetch" href="/note-book2/assets/js/63.cc24e8bc.js"><link rel="prefetch" href="/note-book2/assets/js/64.802122fc.js"><link rel="prefetch" href="/note-book2/assets/js/65.556453a9.js"><link rel="prefetch" href="/note-book2/assets/js/66.46dd694f.js"><link rel="prefetch" href="/note-book2/assets/js/67.27da99f2.js"><link rel="prefetch" href="/note-book2/assets/js/68.151cbe8f.js"><link rel="prefetch" href="/note-book2/assets/js/69.caaec2a6.js"><link rel="prefetch" href="/note-book2/assets/js/7.3774c331.js"><link rel="prefetch" href="/note-book2/assets/js/70.98010beb.js"><link rel="prefetch" href="/note-book2/assets/js/71.849d411e.js"><link rel="prefetch" href="/note-book2/assets/js/72.704bc2a2.js"><link rel="prefetch" href="/note-book2/assets/js/73.860444f4.js"><link rel="prefetch" href="/note-book2/assets/js/74.15ceb970.js"><link rel="prefetch" href="/note-book2/assets/js/75.28740ce3.js"><link rel="prefetch" href="/note-book2/assets/js/76.deacd6df.js"><link rel="prefetch" href="/note-book2/assets/js/77.bcd3554b.js"><link rel="prefetch" href="/note-book2/assets/js/78.aabaa742.js"><link rel="prefetch" href="/note-book2/assets/js/79.91d44973.js"><link rel="prefetch" href="/note-book2/assets/js/8.dadf2583.js"><link rel="prefetch" href="/note-book2/assets/js/80.9a9f10ad.js"><link rel="prefetch" href="/note-book2/assets/js/81.ca479f90.js"><link rel="prefetch" href="/note-book2/assets/js/82.41df5505.js"><link rel="prefetch" href="/note-book2/assets/js/83.dd55e36e.js"><link rel="prefetch" href="/note-book2/assets/js/84.8396514d.js"><link rel="prefetch" href="/note-book2/assets/js/85.11f58f14.js"><link rel="prefetch" href="/note-book2/assets/js/86.7de62cb8.js"><link rel="prefetch" href="/note-book2/assets/js/87.770543de.js"><link rel="prefetch" href="/note-book2/assets/js/88.4e41da97.js"><link rel="prefetch" href="/note-book2/assets/js/89.1d3740a0.js"><link rel="prefetch" href="/note-book2/assets/js/9.2eeae245.js"><link rel="prefetch" href="/note-book2/assets/js/90.6824a467.js"><link rel="prefetch" href="/note-book2/assets/js/91.cc700217.js">
    <link rel="stylesheet" href="/note-book2/assets/css/0.styles.36b9479e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/note-book2/" class="home-link router-link-active"><img src="/note-book2/mlogo.svg" alt="NOTE-BOOK2" class="logo"> <span class="site-name can-hide">NOTE-BOOK2</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/note-book2/monitor-tuning/" class="nav-link router-link-active">
  JAVA 生产环境下性能监控与调优详解
</a></div><div class="nav-item"><a href="/note-book2/http-protocol/" class="nav-link">
  透视 HTTP 协议
</a></div> <a href="https://github.com/zq99299/note-book2" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/note-book2/monitor-tuning/" class="nav-link router-link-active">
  JAVA 生产环境下性能监控与调优详解
</a></div><div class="nav-item"><a href="/note-book2/http-protocol/" class="nav-link">
  透视 HTTP 协议
</a></div> <a href="https://github.com/zq99299/note-book2" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/note-book2/monitor-tuning/" aria-current="page" class="sidebar-link">JAVA 生产环境下性能监控与调优详解</a></li><li><a href="/note-book2/monitor-tuning/00.html" class="sidebar-link">为什么要学习这课程？</a></li><li><section class="sidebar-group collapsable depth-0"><a href="/note-book2/monitor-tuning/01/" class="sidebar-heading clickable"><span>基于 JDK 命令行工具的监控</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/note-book2/monitor-tuning/02/" class="sidebar-heading clickable"><span>基于 JVisualVM 的可视化监控</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/note-book2/monitor-tuning/03/" class="sidebar-heading clickable"><span>基于 Btrace 的监控调试</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/note-book2/monitor-tuning/04/" class="sidebar-heading clickable"><span>Tomcat 性能监控与调优</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/note-book2/monitor-tuning/05/" class="sidebar-heading clickable"><span>Nginx 性能监控与调优</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/note-book2/monitor-tuning/06/" class="sidebar-heading clickable router-link-active open"><span>JVM 层 GC 调优</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/note-book2/monitor-tuning/06/01.html" class="sidebar-link">JVM 内存结构：基于 JDK 1.8</a></li><li><a href="/note-book2/monitor-tuning/06/02.html" class="sidebar-link">垃圾回收算法</a></li><li><a href="/note-book2/monitor-tuning/06/03.html" aria-current="page" class="active sidebar-link">垃圾收集器</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note-book2/monitor-tuning/06/03.html#串行收集器" class="sidebar-link">串行收集器</a></li><li class="sidebar-sub-header"><a href="/note-book2/monitor-tuning/06/03.html#并行-vs-并发" class="sidebar-link">并行 VS 并发</a></li><li class="sidebar-sub-header"><a href="/note-book2/monitor-tuning/06/03.html#停顿时间-vs-吞吐量" class="sidebar-link">停顿时间 VS 吞吐量</a></li><li class="sidebar-sub-header"><a href="/note-book2/monitor-tuning/06/03.html#串行收集器-2" class="sidebar-link">串行收集器</a></li><li class="sidebar-sub-header"><a href="/note-book2/monitor-tuning/06/03.html#并行收集器" class="sidebar-link">并行收集器</a></li><li class="sidebar-sub-header"><a href="/note-book2/monitor-tuning/06/03.html#并发收集器" class="sidebar-link">并发收集器</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note-book2/monitor-tuning/06/03.html#cms" class="sidebar-link">CMS</a></li><li class="sidebar-sub-header"><a href="/note-book2/monitor-tuning/06/03.html#g1" class="sidebar-link">G1</a></li></ul></li><li class="sidebar-sub-header"><a href="/note-book2/monitor-tuning/06/03.html#垃圾收集器搭配" class="sidebar-link">垃圾收集器搭配</a></li><li class="sidebar-sub-header"><a href="/note-book2/monitor-tuning/06/03.html#如何选择垃圾收集器" class="sidebar-link">如何选择垃圾收集器</a></li><li class="sidebar-sub-header"><a href="/note-book2/monitor-tuning/06/03.html#parallel-collector" class="sidebar-link">Parallel Collector</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note-book2/monitor-tuning/06/03.html#动态内存调整" class="sidebar-link">动态内存调整</a></li></ul></li><li class="sidebar-sub-header"><a href="/note-book2/monitor-tuning/06/03.html#cms-collector" class="sidebar-link">CMS Collector</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note-book2/monitor-tuning/06/03.html#cms-垃圾收集过程" class="sidebar-link">CMS 垃圾收集过程</a></li><li class="sidebar-sub-header"><a href="/note-book2/monitor-tuning/06/03.html#cms-缺点" class="sidebar-link">CMS 缺点</a></li><li class="sidebar-sub-header"><a href="/note-book2/monitor-tuning/06/03.html#cms-的相关参数" class="sidebar-link">CMS 的相关参数</a></li></ul></li><li class="sidebar-sub-header"><a href="/note-book2/monitor-tuning/06/03.html#g1-collector" class="sidebar-link">G1 Collector</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note-book2/monitor-tuning/06/03.html#g1-的概念" class="sidebar-link">G1 的概念</a></li><li class="sidebar-sub-header"><a href="/note-book2/monitor-tuning/06/03.html#younggc" class="sidebar-link">YoungGC</a></li><li class="sidebar-sub-header"><a href="/note-book2/monitor-tuning/06/03.html#mixedgc" class="sidebar-link">MixedGC</a></li><li class="sidebar-sub-header"><a href="/note-book2/monitor-tuning/06/03.html#mixedgc-相关参数" class="sidebar-link">MixedGC 相关参数</a></li><li class="sidebar-sub-header"><a href="/note-book2/monitor-tuning/06/03.html#常用参数" class="sidebar-link">常用参数</a></li><li class="sidebar-sub-header"><a href="/note-book2/monitor-tuning/06/03.html#最佳实践" class="sidebar-link">最佳实践</a></li><li class="sidebar-sub-header"><a href="/note-book2/monitor-tuning/06/03.html#是否需要切换到-g1" class="sidebar-link">是否需要切换到 G1</a></li></ul></li></ul></li><li><a href="/note-book2/monitor-tuning/06/04.html" class="sidebar-link">GC 日志格式与可视化日志分析工具</a></li><li><a href="/note-book2/monitor-tuning/06/05.html" class="sidebar-link">Tomcat 的 GC 调优实战</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/note-book2/monitor-tuning/07/" class="sidebar-heading clickable"><span>Java 代码层优化</span> <span class="arrow right"></span></a> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="垃圾收集器"><a href="#垃圾收集器" class="header-anchor">#</a> 垃圾收集器</h1> <p>常见的垃圾收集器有三种：</p> <ul><li><p>串行收集器 Serial：Serial、Serial Old</p></li> <li><p>并行收集器 Parallel：Parallel Scavenge、Parallel Old 以吞吐量优先</p></li> <li><p>并发收集器 Concurrent：</p> <ul><li>CMS</li> <li>G1</li></ul> <p>停顿时间优先，也就是响应时间有限</p></li></ul> <h2 id="串行收集器"><a href="#串行收集器" class="header-anchor">#</a> 串行收集器</h2> <p>单线程的，发现 jvm 内存不够用，暂停应用程序的执行，执行垃圾回收，回收完成之后，再继续执行应用程序</p> <p>主要用于嵌入式的小型内存场景中。</p> <h2 id="并行-vs-并发"><a href="#并行-vs-并发" class="header-anchor">#</a> 并行 VS 并发</h2> <p>垃圾收集器中的并行并发并不是平时高并发中的并发。</p> <ul><li><p>并行（Parallel）</p> <p>指多条垃圾收集线程并行工作，但此时 <strong>用户线程仍然处于等待状态</strong>。</p> <p>适合科学计算、后台处理等弱交互场景。</p></li> <li><p>并发（Concurrent）</p> <p>指用户线程与垃圾收集器线程同时执行（但不定是并行的，可能会交替执行），垃圾收集线程在执行的时候不会停顿用户程序的运行。</p> <p>适合对响应时间有要求的场景，比如 Web</p></li></ul> <h2 id="停顿时间-vs-吞吐量"><a href="#停顿时间-vs-吞吐量" class="header-anchor">#</a> 停顿时间 VS 吞吐量</h2> <p>垃圾收集器中的吞吐量也不是平时高并发中的吞吐量</p> <ul><li><p>停顿时间</p> <p>垃圾收集器做垃圾回收中断应用执行的时间。 <code>-XX:MaxGCPauseMillis</code></p></li> <li><p>吞吐量</p> <p>花在 <strong>垃圾收集</strong> 的时间和花在 <strong>应用时间</strong> 的占比。</p> <p><code>-XX:GCTimeRatio=&lt;n&gt;</code>，垃圾收集时间占 <code>1/1 + n</code></p></li></ul> <p>评判一个垃圾收集器的好坏：在吞吐量最佳的时候，停顿时间最少。但是在现实中，这两个指标很难同时做到都优秀，一般都是互斥的。</p> <h2 id="串行收集器-2"><a href="#串行收集器-2" class="header-anchor">#</a> 串行收集器</h2> <p>开启串行收集器：</p> <ul><li><p><code>-XX:+UseSerialGC</code>：这个是对新生代开启串行，但是会将老生代默认启用下面的参数，也就是老生代的串行 GC</p></li> <li><p><code>-XX:+UseSerialOldGC</code></p></li></ul> <h2 id="并行收集器"><a href="#并行收集器" class="header-anchor">#</a> 并行收集器</h2> <p>它是以 <strong>吞吐量优先</strong> 的垃圾收集器，开启方式：</p> <ul><li><code>-XX:+UseParallelGC</code></li> <li><code>-XX:+UseParallelOldGC</code></li></ul> <p>该收集器在 Server 模式下是默认的收集器。</p> <div class="custom-block tip"><p class="custom-block-title">什么是 Server 模式？</p> <p>jvm 会根据当前机器的配置判定开启 server 模式还是 client 模式，一般来说，机器内存大于 2G，就会启用 server 模式</p></div> <p>下面可以来看下我们启动的应用程序默认启用的垃圾收集器</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>mrcode@mrcode ~ % jps -l
<span class="token number">20572</span> org.gradle.launcher.daemon.bootstrap.GradleDaemon
<span class="token number">20575</span> cn.mrcode.stady.monitor_tuning.MonitorTuningApplication

mrcode@mrcode ~ % jinfo -flag UseParallelGC <span class="token number">20575</span>
-XX:+UseParallelGC
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h2 id="并发收集器"><a href="#并发收集器" class="header-anchor">#</a> 并发收集器</h2> <p>是以响应时间有限的垃圾收集器。在 JDK 中有两种并行的收集器，开启方法如下：</p> <h3 id="cms"><a href="#cms" class="header-anchor">#</a> CMS</h3> <ul><li><p><code>-XX:+UseConcMarkSweepGC</code></p></li> <li><p><code>-XX:+UseParNewGC</code></p></li></ul> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 首先看现在的应用，该收集器并没有开启</span>
mrcode@mrcode ~ % jinfo -flag UseConcMarkSweepGC <span class="token number">20575</span> 
-XX:-UseConcMarkSweepGC

<span class="token comment"># 添加启动参数，并重启程序后，再次观察</span>
mrcode@mrcode ~ % jinfo -flag UseConcMarkSweepGC <span class="token number">20801</span>
-XX:+UseConcMarkSweepGC
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="g1"><a href="#g1" class="header-anchor">#</a> G1</h3> <p>开启方式：<code>-XX:+UseG1GC</code></p> <h2 id="垃圾收集器搭配"><a href="#垃圾收集器搭配" class="header-anchor">#</a> 垃圾收集器搭配</h2> <p>在不同的区里面使用的垃圾收集器不同，前面讲过，JDK 使用的是分代垃圾回收方式</p> <p><img src="/note-book2/assets/img/image-20210202221029440.debb7132.png" alt="image-20210202221029440"></p> <p>两个区里面的收集器不一样，但是上线有连线的是成对搭配使用的。在 JDK8+ 中，建议使用 G1 收集器，性能较高</p> <p>其中虚线是在某些情况下，CMS 会退化成 SerialOld 收集器。我们课程的终点是  G1 收集器。</p> <h2 id="如何选择垃圾收集器"><a href="#如何选择垃圾收集器" class="header-anchor">#</a> 如何选择垃圾收集器</h2> <p>一般有如下建议：</p> <ul><li>优先调整堆的大小，让服务器自己来选择</li> <li>如果内存小于 100M，使用串行收集器</li> <li>如果是单核，并且没有停顿时间的要求，串行或则 JVM 自己选择</li> <li>如果允许停顿时间超过 1 秒，选择并行或则 JVM 自己选择</li> <li>如果响应时间最重要，并且不能超过 1 秒，使用并发收集器</li></ul> <p>官方文档中有讲解，在 <a href="https://docs.oracle.com/javase/8/" target="_blank" rel="noopener noreferrer">JDK8<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 页面中的 <a href="https://docs.oracle.com/javase/8/docs/technotes/guides/vm/gctuning" target="_blank" rel="noopener noreferrer"><strong>HotSpot Virtual Machine Garbage Collection Tuning Guide</strong><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 中，专门讲解如何进行 GC 调优。非常详细</p> <h2 id="parallel-collector"><a href="#parallel-collector" class="header-anchor">#</a> Parallel Collector</h2> <ul><li><p><code>-XX:+UseParallelGC</code>  手动开启</p> <p>Server 模式默认开启</p></li> <li><p><code>-XX:ParallelGCThreads=&lt;N&gt;</code> 使用 n 个 GC 线程</p> <p>默认 n 为以下计算方式：</p> <ul><li><code>CPU &gt; 8</code>：<code>N=5/8</code></li> <li><code>CPU &lt; 8</code>：<code>N=CPU</code></li></ul></li></ul> <p>垃圾收集器有一个自适应功能（Ergonomics），比如设置以下三个参数：</p> <ul><li><code>-XX:MaxGCPauseMillis=&lt;N&gt;</code></li> <li><code>-xx:GCTimeRatio=&lt;N&gt;</code></li> <li><code>-Xmx&lt;N&gt;</code></li></ul> <p>它会按照顺序平衡前两个。也就是会进行动态的调整各个区的大小</p> <h3 id="动态内存调整"><a href="#动态内存调整" class="header-anchor">#</a> 动态内存调整</h3> <ul><li><p><code>-XX:YoungGenerationSizelncrement=&lt;Y&gt;</code>：增加 Young 区内存大小，默认值为 20%</p></li> <li><p><code>-XX:TenuredGenerationSizelncrement=&lt;Y&gt;</code>：增加 Old 区内存大小，默认值为 20%</p></li> <li><p><code>-XX:AdaptiveSizeDecrementScaleFactor=&lt;Y&gt;</code>：：减少内存大小，默认值为 4%</p></li></ul> <h2 id="cms-collector"><a href="#cms-collector" class="header-anchor">#</a> CMS Collector</h2> <p>它是一个 <strong>并发收集</strong>，低停顿、低延迟，是一个老年代收集器</p> <h3 id="cms-垃圾收集过程"><a href="#cms-垃圾收集过程" class="header-anchor">#</a> CMS 垃圾收集过程</h3> <ol><li><p>CMS initial mark：初始标记 Root，STW （停止应用程序）</p></li> <li><p>CMS concurrent mark：并发标记</p></li> <li><p>CMS-concurrent-preclean：并发预清理</p></li> <li><p>CMS remark：重新标记，STW（停止应用程序）</p> <p>此时应用程序还在运行，有可能又有垃圾了，所以重新标记</p></li> <li><p>CMS concurrent sweep：并发清除</p></li> <li><p>CMS concurrent reset：并发重置</p></li></ol> <h3 id="cms-缺点"><a href="#cms-缺点" class="header-anchor">#</a> CMS 缺点</h3> <ul><li><p>CPU 敏感</p> <p>比如设置一个并发线程，那么只有双核的时候，垃圾收集器就会占用其中一个，这个时候就只有一个核心为应用工作了</p></li> <li><p>浮动垃圾：会产生浮动垃圾</p> <p>因为程序还在运行，一边回收，一边分配，就会产生浮动垃圾</p></li> <li><p>空间碎片</p></li></ul> <h3 id="cms-的相关参数"><a href="#cms-的相关参数" class="header-anchor">#</a> CMS 的相关参数</h3> <ul><li><p><code>-XX:ConcGCThreads</code>：并发的 GC 线程数</p></li> <li><p><code>-XX:+UseCMSCompactAtFullCollection</code>：FullGC 之后做压缩</p> <p>上面说会产生碎片，所内存压缩就相当于在清除空间碎片</p></li> <li><p><code>-XX:CMSFullGCsBeforeCompaction</code>：多少次 FUllGC 之后压缩一次</p></li> <li><p><code>-XX:CMSInitiatingOccupancyFraction</code>：触发 FullGC</p> <p>Old 区在填满多少存活对象的时候触发一次 FullGC，该值默认值应该是 90%+</p></li> <li><p><code>-XX:+UseCMSInitatingOccupancyOnly</code>：是否动态调整</p></li> <li><p><code>-XX:+CMSScavengeBeforeRemark</code>：FullGC 之前先做 YGC</p> <p>因为在 YGC 之后，会回收一部分垃圾，再做 Old GC 的时候就会减少很多工作。</p> <p>笔者疑问：但是不是说是分代垃圾回收吗？怎么还会跨区影响？</p></li> <li><p><code>-XX:CMSClassUnloadingEnabled</code>：启用回收 Perm 区</p> <p>JDK7 以前有该区</p></li></ul> <p>如果没有设置，显示 -1，在文档中有说明它的默认值是多少。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>mrcode@mrcode ~ % jinfo -flag CMSInitiatingOccupancyFraction 20572 
-XX:CMSInitiatingOccupancyFraction=-1
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>CMS 还有一个 iCMS，适用于单核或则双核，因为核数少时，垃圾比较多，回收一次占用时间过长，就会影响应用程序，iCMS 就是为了优化这一点，分多次回收。</p> <h2 id="g1-collector"><a href="#g1-collector" class="header-anchor">#</a> G1 Collector</h2> <p>JDK8 中支持的垃圾回收器，不断的在进化，在 JDK11 中又有了其他的垃圾回收器</p> <p><a href="https://docs.oracle.com/javase/8/docs/technotes/guides/vm/gctuning/g1_gc.html#garbage_first_garbage_collection" target="_blank" rel="noopener noreferrer">Garbage-First（G1）<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 垃圾收集器是一种服务器样式的垃圾收集器，适用于具有大内存的多处理器计算机。它试图以高概率满足垃圾收集（GC）暂停时间目标，同时实现高吞吐量。全堆操作（例如全局标记）与应用程序线程同时执行。这样可以防止与堆或活动数据大小成比例的中断。</p> <p>G1 收集器通过多种技术实现了高性能和暂停时间目标。</p> <p>G1 的首要重点是为运行需要大堆且 GC 延迟有限的应用程序的用户提供解决方案。这意味着堆大小约为 6 GB 或更大，并且稳定且可预测的暂停时间低于 0.5 秒。</p> <p>它同时是新生代和老生代收集器</p> <p><img src="/note-book2/assets/img/jsgct_dt_004_grbg_frst_hp.efdc1cd9.png" alt="如下图9-1所示"></p> <p>它是将堆划分成一块一块的，在逻辑上某些块组成了各种数据区，比如 Old 区。</p> <h3 id="g1-的概念"><a href="#g1-的概念" class="header-anchor">#</a> G1 的概念</h3> <ul><li><p>Region：比如上图中的 H，几个块组成的一个区</p></li> <li><p>SATB：Snapshot-At-The-Beginning</p> <p>它是通过 Root Tracing 得到的，GC 开始时候存活对象的快照，后面再做垃圾回收的时候，会以此基础作为回收</p></li> <li><p>Rset：记录了其他 Region 中的对应引用本 Region 中对象的关系，属于 points-into 结构（谁引用了我的对象）</p></li></ul> <h3 id="younggc"><a href="#younggc" class="header-anchor">#</a> YoungGC</h3> <ul><li>新对象进入 Eden 区</li> <li>存活对象拷贝到 Survivor 区</li> <li>存活时间到达年龄阈值时，对象晋升到 Old 区</li></ul> <h3 id="mixedgc"><a href="#mixedgc" class="header-anchor">#</a> MixedGC</h3> <ul><li><p>回收所有的 Young 和 <strong>部分 Old</strong>，所以不是 FullGC</p> <p>这一部分可以通过某些参数设置</p></li> <li><p>global concurrent marking：全局并发标记</p> <ol><li>Initial marking phase：标记 GC Root，STW</li> <li>Root region scanning phase：标记存活 Region</li> <li>Concurrent marking phase：标记存活的对象</li> <li>Remark phase：重新标记，STW</li> <li>Cleanup phase：部分 STW</li></ol></li> <li><p>MixedGC 时机，通过以下参数控制</p> <ul><li><code>InitiatingHeapOccupancyPercent</code>：堆占有率达到这个数值则触发 global concurrent marking ，默认 45%</li> <li><code>G1HeapWastePercent</code>：在 global concurrent marking 结束之后，可以知道区有多少空间要被回收，在每次 YGC 之后和再次发生 Mixed GC 之前，会检查垃圾占比是否达到此参数，只有达到了，下次才会发生 Mixed GC。</li></ul></li></ul> <h3 id="mixedgc-相关参数"><a href="#mixedgc-相关参数" class="header-anchor">#</a> MixedGC 相关参数</h3> <ul><li><p><code>G1MixedGCLiveThresholdPercent</code></p> <p>Old 区的 region 被回收时候的存活对象占比</p></li> <li><p><code>G1MixedGCCountTarget</code></p> <p>一次 global concurrent marking 之后，最多执行 Mixed GC 的次数</p></li> <li><p><code>G1OldCSetRegionThresholdPercent</code></p> <p>一次 Mixed GC 中能被选入 CSet 的最多 old 区的 region 数量</p></li></ul> <h3 id="常用参数"><a href="#常用参数" class="header-anchor">#</a> 常用参数</h3> <ul><li><code>-XX:+UseG1GC</code>：开启 G1</li> <li><code>-XX:G1HeapRegionSize=n</code>：region 的大小，1-32M，最多 2048 个</li> <li><code>-XX:MaxGCPauseMillis=200</code>：最大停顿时间</li> <li><code>-XX:G1NewSizePercent</code></li> <li><code>-XX:G1MaxNewSizePercent</code></li> <li><code>-XX:G1ReservePercent=10</code> ：保留防止 to space 溢出，默认是百分之 10</li> <li><code>-XX:ParallelGCThreads=n</code> ：SWT 线程数</li> <li><code>-XX:ConcGCThreads=n</code> ：并发线程数= <code>1/4*并行</code></li></ul> <h3 id="最佳实践"><a href="#最佳实践" class="header-anchor">#</a> 最佳实践</h3> <ul><li><p>年轻代大小：</p> <p>避免使用 <code>-Xmn</code>、<code>-XX:NewRatio</code> 等显示设置 Young 区大小，会覆盖暂停时间目标</p></li> <li><p>暂停时间目标：</p> <p>暂停时间不要太严苛，其吞吐量目标是 90% 的应用程序时间和 10% 的垃圾回收时间，太严苛会直接影响到吞吐量</p></li></ul> <p>MixGC 调优：</p> <ul><li><code>-XX:InitiatingHeapOccupancyPercent</code></li> <li><code>-XX:G1MixedGCLiveThresholdPercent</code>、<code>-XX:G1HeapWastePercent</code></li> <li><code>-XX:G1MixedGCCountTarget</code></li> <li><code>-XX:G1OldCSetRegionThresholdPercent</code></li></ul> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>本章笔者是第一次接触，看得有点懵逼，记录也只是硬着头皮记录下来，某些并没有看懂</p> <p>后续有此需求，还是需要去阅读官方文档的调优指南来理解。</p></div> <h3 id="是否需要切换到-g1"><a href="#是否需要切换到-g1" class="header-anchor">#</a> 是否需要切换到 G1</h3> <ul><li>50% 以上的堆被存活对象占用</li> <li>对象分配和晋升的速度变化非常大</li> <li>垃圾回收时间特别长，超过了 1 秒</li></ul></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/zq99299/note-book2/edit/man/docs/monitor-tuning/06/03.md" target="_blank" rel="noopener noreferrer">帮助我们改善此页面！</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2021-03-09 02:41:07</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/note-book2/monitor-tuning/06/02.html" class="prev">
        垃圾回收算法
      </a></span> <span class="next"><a href="/note-book2/monitor-tuning/06/04.html">
        GC 日志格式与可视化日志分析工具
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/note-book2/assets/js/app.a3ae7deb.js" defer></script><script src="/note-book2/assets/js/2.ad0c12e6.js" defer></script><script src="/note-book2/assets/js/30.4b2ae139.js" defer></script><script src="/note-book2/assets/js/20.86219d72.js" defer></script>
  </body>
</html>
